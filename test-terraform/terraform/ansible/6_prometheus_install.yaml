---
- hosts: prometheus
  tasks:
    - name: "Создаем группу:"
      group:
        name: prometheus
        state: present

    - name: "Создаем пользователя и помещаем его в группу:"
      user:
        name: prometheus
        groups: prometheus
        state: present

    - name: "Создаем директорию /tmp/prometheus:"
      file:
        path: /tmp/prometheus
        state: directory
        owner: root
        group: root
        mode: 0644

    - name: "Скачиваем архив:"
      ansible.builtin.unarchive:
        src: /home/alifanov/source/prometheus-2.47.2.linux-amd64.tar.gz
        dest: /tmp/prometheus
        remote_src: yes

    - name: "Создаем директорию /etc/prometheus"
      file:
        path: /etc/prometheus
        state: directory
        owner: prometheus
        group: prometheus
        mode: 0775

    - name: "Создаем директорию /var/lib/prometheus" 
      file:
        path: /var/lib/prometheus
        state: directory
        owner: prometheus
        group: prometheus
        mode: 0775

    - name: "Копируем файлы архива в /usr/local/bin/"
      copy:
        src: /tmp/prometheus/prometheus-2.47.2.linux-amd64/prometheus
        dest: /usr/local/bin/
        remote_src: yes

    - name: "Копируем promtool в /usr/local/bin/"
      copy:
        src: /tmp/prometheus/prometheus-2.47.2.linux-amd64/promtool
        dest: /usr/local/bin/
        remote_src: yes

    - name: "Копируем console_libraries в /etc/prometheus"
      copy:
        src: /tmp/prometheus/prometheus-2.47.2.linux-amd64/console_libraries
        dest: /etc/prometheus
        remote_src: yes

    - name: "Копируем console file в /etc/prometheus"
      copy:
        src: /tmp/prometheus/prometheus-2.47.2.linux-amd64/consoles
        dest: /etc/prometheus
        remote_src: yes

    - name: "Копируем prometheus.yml в /etc/prometheus"
      copy:
        src: /tmp/prometheus/prometheus-2.47.2.linux-amd64/prometheus.yml
        dest: /etc/prometheus
        remote_src: yes

    - name: "chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus"
      command: chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus

    - name: "chown prometheus:prometheus /usr/local/bin/prometheus"
      command: chown prometheus:prometheus /usr/local/bin/prometheus

    - name: "chown prometheus:prometheus /usr/local/bin/promtool"
      command: chown prometheus:prometheus /usr/local/bin/promtool

    - name: "chmod +x /usr/local/bin/promtool"
      command: chmod +x /usr/local/bin/promtool

    - name: "chmod +x /usr/local/bin/prometheus"
      command: chmod +x /usr/local/bin/prometheus

    - name: "Создаем prometheus.service"
      file:
        path: "/etc/systemd/system/prometheus.service"
        owner: root
        group: root
        mode: 0775
        state: touch

    - name: "Добавляем содержимое prometheus.service"
      lineinfile:
        dest: /etc/systemd/system/prometheus.service
        line: "{{ item }}"
      with_items:
        - "[Unit]"
        - Description=Prometheus Service Netology Lesson 9.4
        - After=network.target
        - "[Service]"
        - User=prometheus
        - Group=prometheus
        - Type=simple
        - ExecStart=/usr/local/bin/prometheus \
        - --config.file /etc/prometheus/prometheus.yml \
        - --storage.tsdb.path /var/lib/prometheus/ \
        - --web.console.templates=/etc/prometheus/consoles \
        - --web.console.libraries=/etc/prometheus/console_libraries
        - ExecReload=/bin/kill -HUP $MAINPID Restart=on-failure
        - "[Install]"
        - WantedBy=multi-user.target

    - name: "chown -R prometheus:prometheus /var/lib/prometheus"
      command: chown -R prometheus:prometheus /var/lib/prometheus

    - name: "Добавляем nginx hosts"
      lineinfile:
        dest: /etc/prometheus/prometheus.yml
        regexp: '^\s*- targets:'
        line: '     - targets: [''192.168.1.11:9090'', ''192.168.1.10:9100'', ''192.168.2.10:9100'', ''192.168.1.10:4040'', ''192.168.2.10:4040'']'
        backrefs: yes
        
    - name: "Перезапускаем демоны:"
      systemd:
        daemon_reload: yes

    - name: "Проверяем работоспособность сервиса:"
      systemd:
        state: started
        name: prometheus


    - name: "Активируем сервис:"
      systemd:
        name: prometheus
        enabled: yes
        masked: no

  become: yes
  become_method: sudo
